/*
 * generated by Xtext
 */
package com.senacor.hh.set.generator

import org.eclipse.emf.ecore.resource.Resource
import org.eclipse.xtext.generator.IGenerator
import org.eclipse.xtext.generator.IFileSystemAccess
import com.senacor.hh.set.setDsl.Service
import com.senacor.hh.set.setDsl.DeploymentEnum

/**
 * Generates code from your model files on save.
 * 
 * see http://www.eclipse.org/Xtext/documentation.html#TutorialCodeGeneration
 */
class SetDslGenerator implements IGenerator {
	
//	override void doGenerate(Resource resource, IFileSystemAccess fsa) {	
//		fsa.generateFile('greetings.txt', 'People to greet: ' + 
//			resource.allContents
//				.filter(typeof(Greeting))
//				.map[name]
//				.join(', '))
//	}
    var rootDir = "/hh-service-project";
    
   
    override void doGenerate(Resource resource, IFileSystemAccess fsa) {
    	// val RootDir rd = resource.allContents.toIterable.findFirst(c | typeof(RootDir).isAssignableFrom(c.class)) as RootDir;
    	// rootDir = rd.dir;
    	
    	System.out.println("starting generation in root-dir: "+rootDir)
    		
    	fsa.generateFile(
    	  rootDir+"/pom.xml", 
    	  Pom.generateRootPom(resource.allContents.toIterable.filter(Service))
    	);
    	
    	for(service: resource.allContents.toIterable.filter(Service)) {
          fsa.generateFile(
    	    rootDir+"/"+service.name+"/pom.xml", 
    	    Pom.generateServicePom(service)
    	  );	
    	  
    	  if (service.deployment == DeploymentEnum.MS) {
            fsa.generateFile(
        	  rootDir+"/"+service.name+"/src/main/java/com/senacor/services/"+service.name+"/AbstractMS"+service.name+".java", 
    	      MicroService.generateAbstractMicroService(service)
    	    );	
    	  } else if (service.deployment == DeploymentEnum.HZ) {
            fsa.generateFile(
    	      rootDir+"/"+service.name+"/src/main/java/com/senacor/services/"+service.name+"/AbstractHZ"+service.name+".java", 
    	      HazelcastService.generateAbstractHazelcastService(service)
    	    );	
    	  }
    	  
    	  if (service.deployment == DeploymentEnum.MS) {
            fsa.generateFile(
    	      rootDir+"/"+service.name+"/src/main/java/com/senacor/services/"+service.name+"/MS"+service.name+"Impl.java", 
    	      MicroService.generateMicroServiceImpl(service)
    	    );	
    	  } else if (service.deployment == DeploymentEnum.HZ) {
            fsa.generateFile(
    	      rootDir+"/"+service.name+"/src/main/java/com/senacor/services/"+service.name+"/HZ"+service.name+"Impl.java", 
    	      HazelcastService.generateHazelcastServiceImpl(service)
    	    );	
    	  }
    	  
    	  	
    	}
	}
}
